---
import Header from '../components/HeaderIndex.astro';
import Layout from '../layouts/Layout.astro';
---

<Layout>
	<Header/>
	<div class="container">

	</div>
</Layout>


<script is:inline>
	const getCookie = async()=>{
		const res = await fetch(`http://localhost:3000/auth`,{
			method: "GET",
			credentials: "include"
		})

		genArticles(res.ok)
	}


	// get products from api source
	const getProducts = async()=>{
		let res = await fetch('https://fakestoreapi.in/api/products')
		res = await res.json()
		// return the articles
		return res
	}	

	// generate the product info in the web page
	const genArticles = async(auth)=>{
		let articles = await getProducts()
		articles = articles.products
		
		const container = document.querySelector(".container")

		//logout btn
		if(auth){
			document.querySelector(".header-container").innerHTML = `
					<button id="logout">Logout</button>
					<button id="profile">Profile</button>
				`
			// profilepage
			const profilebtn = document.querySelector("#profile")
			profilebtn.addEventListener("click",async()=>{
				const res = await fetch("http://localhost:3000/profile",{
					method: "GET",
					credentials: "include"
				})

				if(!res.ok){
					window.location.href = "/"
				}

				window.location.href = "/profile"

				//window.location.href = "/profile"
			})
			// logout
			const logoutBtn =  document.querySelector("#logout")
			logoutBtn.addEventListener("click",async()=>{
				await fetch(`http://localhost:3000/logout`,{
					method: "GET",
					credentials: "include"
				})

				window.location.href = "/"
			})
		}

		articles.forEach(element => {
			//console.log(element)
			const item = document.createElement("div")
			item.addEventListener("click",()=>{
				window.location.href = `/item/${element.id}`
			})

			item.classList.add("item-container")
			item.innerHTML = `
				<h5 class="item-title">${element.title}</h5>
				<div class="image-container">
					<img class="item-image" src="${element.image}">
				</div>
				<div class="item-info">
					<p>Category: ${element.category}</p>
					<p>Price $${element.price}</p>
				</div>
			`
			if(auth){
				const addToCart = document.createElement("button")
				addToCart.textContent = "Add to cart"
				item.appendChild(addToCart)
			}
			container.appendChild(item)
		});
	}
	

	getCookie()
</script>

<style is:inline>
	.container{
		display: grid;
		grid-template-columns: repeat(3, 1fr);
		grid-template-rows: auto;
		gap: 1em;
		margin: 1em;
	}
	
	.item-container{
		width: 100%;
		display: flex;
		flex-direction: column;
		justify-items: center;
		align-items: center;
	}

	.item-container > h4{
		font-family: Arial, Helvetica, sans-serif;
	}
	
	.image-container{
		width: 6em;
	}

	.item-image{
		max-width: 100%;
		width: auto;
	}
	.item-info{
		display: flex;
		flex-direction: row;
		gap: 1em;
	}
</style>